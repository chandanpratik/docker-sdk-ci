#!/bin/bash
# Author: Chandan Kumar

# Import the bootstrap function
source "$(dirname "$0")/bootstrap.sh"

# Define colors
GREEN="\e[32m"
YELLOW="\e[33m"
RED="\e[31m"
BLUE="\e[34m"
CYAN="\e[36m"
RESET="\e[0m"

# List of containers to manage
containers=("ci4-php" "ci4-nginx" "ci4-mariadb" "ci4-phpmyadmin")

# Check if a container exists (running or stopped)
does_container_exist() {
    docker ps -a --filter "name=$1" -q | grep -q .
}

# Check if a container is running
is_container_running() {
    docker ps --filter "name=$1" --filter "status=running" -q | grep -q .
}

# Stop only the listed containers (preserve volumes)
stop_containers() {
    echo -e "ğŸ›‘ ${RED}Stopping selected CI4 Docker containers...${RESET}"
    for container in "${containers[@]}"; do
        if does_container_exist "$container"; then
            docker stop "$container"
        fi
    done
}

# Start or restart only the listed containers
start_or_restart_containers() {
    echo -e "ğŸš€ ${CYAN}Ensuring CI4 Docker containers are running...${RESET}"
    for container in "${containers[@]}"; do
        if is_container_running "$container"; then
            echo -e "ğŸ”„ Restarting ${GREEN}$container${RESET}..."
            docker restart "$container"
        elif does_container_exist "$container"; then
            echo -e "âš¡ ${YELLOW}$container exists but is stopped. Starting it...${RESET}"
            docker start "$container"
        else
            echo -e "ğŸš€ ${CYAN}$container not found. Building and starting it...${RESET}"
            docker-compose up -d --build "$container"
        fi
    done
}

# Banner function
show_banner() {
    echo -e "${GREEN}"
    echo "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ   â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ    â–ˆâ–ˆ "
    echo " â–ˆâ–ˆ       â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ   â–ˆâ–ˆ "
    echo " â–ˆâ–ˆ       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ "
    echo " â–ˆâ–ˆ       â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ  â–ˆâ–ˆ â–ˆâ–ˆ "
    echo "  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ   â–ˆâ–ˆ â–ˆâ–ˆ   â–ˆâ–ˆâ–ˆâ–ˆ "
    echo -e "${BLUE}"

    echo -e "${GREEN}"
    echo "â”Œâ”€â”€â”€â”€â•®       â”Œâ”€â”           â•­â”€â”€â”€â”€â”¬â”€â”€â”€â”€â•®â”€â”¬â”€â”"
    echo "â”‚  â•® â”‚â”€â”€â”€â”¬â”€â”€â”€â”¤ â”œâ”€â”¬â”€â”€â”€â”¬â”€â”¬â”€â” â”‚ â”€â”€â”€â”¤  â•® â”‚ â”Œâ”€â”˜"
    echo "â”‚  â•¯ â”‚ â”¼ â”‚ â”œâ”€â”¤â”€â”€â”€â”¤ â”¼â”€â”¤ â”Œâ”€â•¯ â”œâ”€â”€â”€ â”‚  â•¯ â”‚ â””â”€â”"
    echo "â””â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”´â”€â”´â”€â”€â”€â”´â”€â”˜   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”´â”€â”˜"
    echo -e "${BLUE}"
}

# Show banner
show_banner

# Command handling
if [ "$1" == "up" ]; then
    stop_containers
    start_or_restart_containers

elif [ "$1" == "down" ]; then
    echo -e "ğŸ›‘ ${RED}Stopping CI4 Docker containers...${RESET}"
    stop_containers  # Only stops, does not remove volumes

elif [ "$1" == "cli" ]; then
    echo -e "${CYAN}Welcome to the CodeIgniter 4 CLI inside Docker!${RESET}"
    echo -e "${YELLOW}Type your CI4 command or 'exit' to quit.${RESET}"
    docker exec -it ci4-php sh

elif [ "$1" == "boot" ]; then
    echo -e "${GREEN}âš¡ Bootstrapping the project...${RESET}"
    bootstrap

else
    echo -e "${RED}âŒ Invalid command!${RESET} Usage:"
    echo -e "${GREEN} docker/sdk up     â†’ Restart CI4 containers"
    echo -e "${GREEN} docker/sdk down   â†’ Stop CI4 containers"
    echo -e "${GREEN} docker/sdk cli    â†’ CLI to CI4 App"
    echo -e "${GREEN} docker/sdk boot   â†’ Bootstrap project setup"
fi
